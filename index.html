<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Platform</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 Babel (用於解析 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. 預加載 Supabase SDK (確保全域變數可用) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 4. 配置 Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- 定義自定義動畫樣式 -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
    
    <!-- React 應用的掛載點 -->
    <div id="root"></div>

    <!-- 5. React 主程式碼 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Play, CheckCircle, XCircle, Download, RotateCcw, FileJson, Clock, Trophy, ChevronRight, BarChart3, User, Medal, LogOut, Loader2, Database, AlertTriangle } from 'lucide-react';

        const SUPABASE_URL = window.SUPABASE_URL || 'https://llrbxpzcmdidlogplcur.supabase.co';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'sb_publishable_SqS1pjivl4Dow8mo5W4HRQ_xkUPsoRo';

        function App() {
            // 應用狀態管理
            const [view, setView] = useState('welcome');
            const [questions, setQuestions] = useState([]);
            const [quizQuestions, setQuizQuestions] = useState([]); // 當前測驗的題目 (隨機抽取的10題)
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState({}); 
            const [quizHistory, setQuizHistory] = useState([]);
            const [currentResult, setCurrentResult] = useState(null);
            
            // 新增/修改狀態
            const [username, setUsername] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [loginError, setLoginError] = useState('');
            
            // 數據加載與 Supabase 客戶端狀態
            const [supabaseClient, setSupabaseClient] = useState(null);
            const [isSupabaseReady, setIsSupabaseReady] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [isLoadingHistory, setIsLoadingHistory] = useState(false);
            const [allowedUsers, setAllowedUsers] = useState([]);
            const [dbError, setDbError] = useState(null);

            // 0. 加載 questions.json (從本地文件)
            useEffect(() => {
                const loadQuestions = async () => {
                    try {
                        const response = await fetch('./questions.json');
                        if (!response.ok) {
                            throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                        }
                        const data = await response.json();
                        if (!Array.isArray(data) || data.length === 0) {
                            throw new Error('questions.json 格式不正確，應為非空數組');
                        }
                        setQuestions(data);
                        console.log(`成功加載 ${data.length} 道題目`);
                    } catch (err) {
                        console.error("載入題庫失敗:", err);
                        setDbError(`無法讀取題庫數據: ${err.message}`);
                    }
                };
                loadQuestions();
            }, []);

            // 1. 初始化 Supabase
            useEffect(() => {
                // 優先使用 window.supabase (如果已由 CDN 加載)
                if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                     try {
                        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        setSupabaseClient(client);
                        setIsSupabaseReady(true);
                    } catch (err) {
                        setDbError("Supabase 初始化失敗: " + err.message);
                    }
                } else {
                    // 如果 window.supabase 不存在，動態注入 script (備用方案)
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script.onload = () => {
                        try {
                            const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                            setSupabaseClient(client);
                            setIsSupabaseReady(true);
                        } catch (err) {
                            setDbError("Supabase 初始化失敗: " + err.message);
                        }
                    };
                    script.onerror = () => {
                        setDbError("無法加載 Supabase SDK，請檢查網絡連接");
                    };
                    document.body.appendChild(script);
                }
            }, []);

            // 2. 初始化數據：當 Supabase 就緒且題庫已加載後，讀取數據
            useEffect(() => {
                if (!isSupabaseReady || !supabaseClient || questions.length === 0) return;

                const initData = async () => {
                    try {
                        setIsLoading(true);
                        setDbError(null);

                        // 讀取用戶名單
                        const { data: usersData, error: usersError } = await supabaseClient
                            .from('users')
                            .select('*');

                        if (usersError) throw usersError;
                        setAllowedUsers(usersData || []);

                        // 讀取排行榜
                        await fetchLeaderboard();

                        setIsLoading(false);
                    } catch (err) {
                        console.error("Supabase Init Error:", err);
                        setDbError(err.message || "無法連接資料庫，請檢查 Supabase 設定 (CORS 或 API Key)");
                        setIsLoading(false);
                    }
                };

                initData();
            }, [isSupabaseReady, supabaseClient, questions.length]);

            // 從 DB 讀取排行榜
            const fetchLeaderboard = async () => {
                if (!supabaseClient) return;
                const { data, error } = await supabaseClient
                    .from('results')
                    .select('user_name, score, created_at')
                    .order('score', { ascending: false });

                if (!error && data) {
                    // 簡單去重邏輯：只取每位用戶的最高分 (或最新)
                    const uniqueLeaders = [];
                    const seenUsers = new Set();
                    for (const entry of data) {
                        if (!seenUsers.has(entry.user_name)) {
                            seenUsers.add(entry.user_name);
                            uniqueLeaders.push(entry);
                        }
                    }
                    setLeaderboard(uniqueLeaders.slice(0, 10));
                }
            };

            // 從 DB 讀取個人歷史
            const fetchHistory = async (userId) => {
                if (!supabaseClient) return;
                setIsLoadingHistory(true);
                const { data, error } = await supabaseClient
                    .from('results')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });
                
                if (!error) {
                    setQuizHistory(data);
                }
                setIsLoadingHistory(false);
            };

            // 登入處理
            const handleLogin = () => {
                if (!username.trim()) {
                    setLoginError('請輸入名字');
                    return;
                }

                const foundUser = allowedUsers.find(
                    u => u.name.toLowerCase() === username.trim().toLowerCase()
                );

                if (foundUser) {
                    setCurrentUser(foundUser);
                    setLoginError('');
                    fetchHistory(foundUser.id);
                } else {
                    setLoginError('找不到該用戶名，請確認您的名字是否在資料庫 users 表中');
                }
            };

            // 登出處理
            const handleLogout = () => {
                if (window.confirm("確定要登出嗎？")) {
                    setCurrentUser(null);
                    setUsername('');
                    setQuizHistory([]);
                    setView('welcome');
                }
            };

            // 開始測驗：隨機抽取 10 題
            const startQuiz = () => {
                if (questions.length < 10) {
                    alert('題庫中的題目數量少於 10 題，無法開始測驗');
                    return;
                }

                // 隨機抽取 10 題
                const shuffled = [...questions].sort(() => Math.random() - 0.5);
                const selectedQuestions = shuffled.slice(0, 10);
                
                setQuizQuestions(selectedQuestions);
                setUserAnswers({});
                setCurrentQuestionIndex(0);
                setCurrentResult(null);
                setView('quiz');
            };

            const handleOptionSelect = (optionId) => {
                setUserAnswers(prev => ({
                    ...prev,
                    [quizQuestions[currentQuestionIndex].id]: optionId
                }));
            };

            const handleNext = () => {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    setCurrentQuestionIndex(prev => prev + 1);
                } else {
                    finishQuiz();
                }
            };

            const finishQuiz = async () => {
                let score = 0;
                const detailedResults = quizQuestions.map(q => {
                    const isCorrect = userAnswers[q.id] === q.correctAnswer;
                    if (isCorrect) score++;
                    return {
                        questionId: q.id,
                        question: q.question,
                        userAnswer: userAnswers[q.id],
                        correctAnswer: q.correctAnswer,
                        isCorrect
                    };
                });

                const resultData = {
                    user_id: currentUser.id,
                    user_name: currentUser.name,
                    score: score,
                    total_questions: quizQuestions.length,
                    percentage: Math.round((score / quizQuestions.length) * 100),
                    details: detailedResults
                };

                // 先顯示結果給用戶
                const displayResult = { ...resultData, created_at: new Date().toISOString() };
                setCurrentResult(displayResult);
                setView('results');
                
                // 寫入 Supabase
                if (supabaseClient) {
                    setIsSaving(true);
                    const { error } = await supabaseClient.from('results').insert([resultData]);
                    
                    if (error) {
                        alert("成績保存失敗: " + error.message);
                    } else {
                        await fetchLeaderboard();
                        await fetchHistory(currentUser.id);
                    }
                    setIsSaving(false);
                }
            };

            const downloadResultJson = () => {
                if (!currentResult) return;
                const jsonString = JSON.stringify(currentResult, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `quiz_result_${currentUser.name}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // --- UI Components ---
            // 修改：將組件定義改為 render 函數，避免在 App 重繪時被卸載導致輸入框失去焦點

            const renderLeaderboardTable = () => (
                <div className="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden w-full max-w-md mt-6">
                    <div className="bg-yellow-50 p-4 border-b border-yellow-100 flex items-center justify-between">
                        <h3 className="font-bold text-yellow-800 flex items-center gap-2">
                            <Trophy className="text-yellow-600" size={20} />
                            榮譽排行榜 (Top 10)
                        </h3>
                    </div>
                    <div className="divide-y divide-gray-100">
                        {leaderboard.length === 0 ? (
                            <div className="p-4 text-center text-gray-400 text-sm">暫無排名數據</div>
                        ) : (
                            leaderboard.map((entry, index) => (
                                <div key={index} className="p-3 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`
                                            w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                                            ${index === 0 ? 'bg-yellow-400 text-white' : 
                                            index === 1 ? 'bg-gray-300 text-white' :
                                            index === 2 ? 'bg-orange-300 text-white' : 'bg-gray-100 text-gray-500'}
                                        `}>
                                            {index + 1}
                                        </div>
                                        <div className="font-medium text-gray-700">
                                            {entry.user_name}
                                            {currentUser && currentUser.name === entry.user_name && 
                                                <span className="ml-2 text-xs bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded">Me</span>
                                            }
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-bold text-indigo-600">{entry.score} 分</div>
                                        <div className="text-xs text-gray-400">{new Date(entry.created_at).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );

            const renderWelcomeScreen = () => (
                <div className="flex flex-col items-center justify-center animate-fade-in text-center p-6 w-full">
                    <div className="bg-indigo-100 p-6 rounded-full mb-6">
                        <Database size={64} className="text-indigo-600" />
                    </div>
                    <div className="space-y-2 mb-8">
                        <h1 className="text-4xl font-bold text-gray-800">智選 Quiz Platform</h1>
                        <p className="text-gray-500 text-lg">雲端數據版</p>
                    </div>

                    <div className="w-full max-w-md space-y-4 mb-8">
                        {!currentUser ? (
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                                <h3 className="text-lg font-bold text-gray-700 mb-4 text-left flex items-center gap-2">
                                    <User size={20} />
                                    考生登入
                                </h3>
                                <div className="flex flex-col gap-3">
                                    <input
                                        type="text"
                                        placeholder="請輸入您的名字 (例如: Guest)"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    />
                                    <button
                                        onClick={handleLogin}
                                        className="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 rounded-lg font-semibold transition-all"
                                        disabled={isLoading}
                                    >
                                        {isLoading ? '資料載入中...' : '確認身份'}
                                    </button>
                                    {loginError && <p className="text-red-500 text-sm text-left">{loginError}</p>}
                                    <div className="text-xs text-gray-400 text-left mt-2">
                                        需使用資料庫中存在的名字 (如: Admin, Guest)
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fade-in">
                                <div className="bg-green-50 text-green-700 p-3 rounded-lg flex items-center justify-center gap-2">
                                    <CheckCircle size={18} />
                                    <span>歡迎回來，<span className="font-bold">{currentUser.name}</span></span>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button 
                                        onClick={startQuiz}
                                        className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-4 px-8 rounded-xl font-semibold text-lg transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1"
                                    >
                                        <Play size={24} />
                                        開始測驗
                                    </button>
                                    <button 
                                        onClick={() => setView('history')}
                                        className="flex items-center justify-center gap-2 bg-white border-2 border-indigo-100 hover:border-indigo-300 text-indigo-600 py-4 px-8 rounded-xl font-semibold text-lg transition-all"
                                    >
                                        <Clock size={24} />
                                        歷史記錄
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {renderLeaderboardTable()}
                </div>
            );

            const renderQuizScreen = () => {
                const currentQuestion = quizQuestions[currentQuestionIndex];
                const isLastQuestion = currentQuestionIndex === quizQuestions.length - 1;
                const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
                const hasAnswered = !!userAnswers[currentQuestion.id];

                return (
                    <div className="w-full max-w-2xl mx-auto p-4 animate-fade-in">
                        <div className="mb-8">
                            <div className="flex justify-between text-sm text-gray-500 mb-2">
                                <span>問題 {currentQuestionIndex + 1} / {quizQuestions.length}</span>
                                <span>{Math.round(progress)}%</span>
                            </div>
                            <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-indigo-500 transition-all duration-500 ease-out"
                                    style={{ width: `${progress}%` }}
                                ></div>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                            <div className="bg-indigo-50 p-6 border-b border-indigo-100">
                                <span className="inline-block px-3 py-1 bg-indigo-200 text-indigo-700 rounded-full text-xs font-bold mb-3">
                                    {currentQuestion.category}
                                </span>
                                <h2 className="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
                                    {currentQuestion.question}
                                </h2>
                            </div>

                            <div className="p-6 space-y-3">
                                {currentQuestion.options.map((option) => {
                                    const isSelected = userAnswers[currentQuestion.id] === option.id;
                                    return (
                                        <button
                                            key={option.id}
                                            onClick={() => handleOptionSelect(option.id)}
                                            className={`w-full text-left p-4 rounded-xl border-2 transition-all flex items-center justify-between group
                                                ${isSelected 
                                                    ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-md' 
                                                    : 'border-gray-100 hover:border-indigo-200 hover:bg-gray-50 text-gray-600'
                                                }`}
                                        >
                                            <div className="flex items-center gap-4">
                                                <span className={`w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold transition-colors
                                                    ${isSelected ? 'bg-indigo-500 text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-indigo-100'}`}>
                                                    {option.id}
                                                </span>
                                                <span className="font-medium">{option.text}</span>
                                            </div>
                                            {isSelected && <CheckCircle size={20} className="text-indigo-500" />}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            <div className="p-6 bg-gray-50 flex justify-end border-t border-gray-100">
                                <button
                                    onClick={handleNext}
                                    disabled={!hasAnswered}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all
                                        ${hasAnswered 
                                            ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg transform hover:-translate-y-1' 
                                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}
                                >
                                    {isLastQuestion ? '查看結果' : '下一題'}
                                    <ChevronRight size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderResultsScreen = () => {
                if (!currentResult) return null;
                const isPassing = currentResult.percentage >= 60;
                
                return (
                    <div className="w-full max-w-3xl mx-auto p-4 animate-fade-in pb-20">
                        <div className="text-center mb-8">
                            <div className={`inline-flex p-4 rounded-full mb-4 ${isPassing ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                                {isPassing ? <Trophy size={48} /> : <BarChart3 size={48} />}
                            </div>
                            <h2 className="text-3xl font-bold text-gray-800">
                                {isPassing ? '恭喜完成！' : '再接再厲！'}
                            </h2>
                            <p className="text-gray-500 mt-2">
                                考生：<span className="font-bold text-gray-800">{currentUser.name}</span>
                            </p>
                            {isSaving && <p className="text-sm text-indigo-500 mt-2 animate-pulse">正在同步成績至雲端...</p>}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <div className="text-gray-400 text-sm mb-1">得分</div>
                                <div className={`text-4xl font-bold ${isPassing ? 'text-green-500' : 'text-orange-500'}`}>
                                    {currentResult.score} / {currentResult.total_questions}
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <div className="text-gray-400 text-sm mb-1">正確率</div>
                                <div className="text-4xl font-bold text-indigo-600">
                                    {currentResult.percentage}%
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center flex flex-col items-center justify-center">
                                <button
                                    onClick={downloadResultJson}
                                    className="w-full flex items-center justify-center gap-2 bg-gray-900 hover:bg-gray-800 text-white py-3 px-4 rounded-xl font-medium transition-all"
                                >
                                    <Download size={18} />
                                    下載 JSON
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
                            <div className="p-4 bg-gray-50 border-b border-gray-100 font-bold text-gray-700">
                                答題詳情
                            </div>
                            <div className="divide-y divide-gray-100">
                                {currentResult.details.map((item, index) => (
                                    <div key={index} className="p-4 md:p-6 hover:bg-gray-50 transition-colors">
                                        <div className="flex items-start gap-3">
                                            <div className={`mt-1 flex-shrink-0 ${item.isCorrect ? 'text-green-500' : 'text-red-500'}`}>
                                                {item.isCorrect ? <CheckCircle size={24} /> : <XCircle size={24} />}
                                            </div>
                                            <div className="flex-1">
                                                <p className="font-medium text-gray-800 mb-2">
                                                    <span className="text-gray-400 mr-2">{index + 1}.</span>
                                                    {item.question}
                                                </p>
                                                <div className="text-sm space-y-1">
                                                    <div className={`flex items-center gap-2 ${item.isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                                                        <span className="font-bold border border-current px-1.5 rounded text-xs">你的答案</span>
                                                        {item.userAnswer ? `選項 ${item.userAnswer}` : '未作答'}
                                                    </div>
                                                    {!item.isCorrect && (
                                                        <div className="flex items-center gap-2 text-green-600">
                                                            <span className="font-bold border border-current px-1.5 rounded text-xs">正確答案</span>
                                                            選項 {item.correctAnswer}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-center">
                            <button
                                onClick={() => setView('welcome')}
                                className="flex items-center gap-2 text-gray-500 hover:text-indigo-600 font-medium px-6 py-3 rounded-lg hover:bg-indigo-50 transition-all"
                            >
                                <RotateCcw size={20} />
                                返回主選單
                            </button>
                        </div>
                    </div>
                );
            };

            const renderHistoryScreen = () => (
                <div className="w-full max-w-3xl mx-auto p-4 animate-fade-in pb-20">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <Clock className="text-indigo-500" />
                            答題歷史 ({currentUser.name})
                        </h2>
                        <button
                            onClick={() => setView('welcome')}
                            className="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg transition-colors"
                        >
                            返回
                        </button>
                    </div>
                    
                    {isLoadingHistory ? (
                        <div className="text-center py-12">
                            <Loader2 size={32} className="text-indigo-500 mx-auto animate-spin" />
                            <p className="text-gray-400 mt-2">載入中...</p>
                        </div>
                    ) : quizHistory.length === 0 ? (
                        <div className="text-center py-12 bg-white rounded-2xl border border-gray-100 shadow-sm">
                            <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <FileJson className="text-gray-300" size={32} />
                            </div>
                            <p className="text-gray-500">您暫無歷史記錄</p>
                            <button 
                                onClick={() => setView('welcome')} 
                                className="mt-4 text-indigo-600 hover:underline font-medium"
                            >
                                立即開始測驗
                            </button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {quizHistory.map((record) => (
                                <div key={record.id} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div>
                                        <div className="text-xs text-gray-400 mb-1">{new Date(record.created_at).toLocaleString('zh-TW')}</div>
                                        <div className="font-bold text-gray-800">得分: {record.score} / {record.total_questions}</div>
                                    </div>
                                    
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <span className={`text-2xl font-bold ${record.percentage >= 60 ? 'text-green-500' : 'text-orange-500'}`}>
                                                {record.percentage}%
                                            </span>
                                        </div>
                                        <button
                                            onClick={() => {
                                                const jsonString = JSON.stringify(record, null, 2);
                                                const blob = new Blob([jsonString], { type: "application/json" });
                                                const url = URL.createObjectURL(blob);
                                                const link = document.createElement('a');
                                                link.href = url;
                                                link.download = `quiz_result_${currentUser.name}_${record.id}.json`;
                                                link.click();
                                            }}
                                            className="p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                                            title="再次下載 JSON"
                                        >
                                            <Download size={20} />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );

            // 錯誤處理
            if (dbError) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center border border-red-100">
                            <div className="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                <AlertTriangle size={32} />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">資料庫連接失敗</h2>
                            <p className="text-red-500 font-medium mb-4">{dbError}</p>
                            <button onClick={() => window.location.reload()} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                重試連接
                            </button>
                        </div>
                    </div>
                );
            }

            // 加載中畫面 (如果是初始加載)
            if (isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 text-indigo-600">
                        <Loader2 size={48} className="animate-spin" />
                        <p className="mt-4 font-medium text-gray-500">正在連接 Supabase 資料庫...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 font-sans">
                    <nav className="bg-white border-b border-gray-200 sticky top-0 z-10">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div 
                                className="flex items-center gap-2 font-bold text-xl text-indigo-600 cursor-pointer"
                                onClick={() => {
                                    if (view === 'quiz') {
                                        if(window.confirm("確定要退出測驗嗎？進度將不會保存。")) setView('welcome');
                                    } else {
                                        setView('welcome');
                                    }
                                }}
                            >
                                <div className="bg-indigo-600 text-white p-1 rounded">
                                    <CheckCircle size={20} />
                                </div>
                                <span>智選 Quiz</span>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                {currentUser && view !== 'quiz' && (
                                    <div className="hidden md:flex items-center gap-2">
                                        <div className="flex items-center gap-2 text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">
                                            <User size={14} />
                                            {currentUser.name}
                                        </div>
                                        <button
                                            onClick={handleLogout}
                                            className="flex items-center gap-1 text-sm text-gray-500 hover:text-red-600 hover:bg-red-50 px-3 py-1 rounded-full transition-all border border-transparent hover:border-red-100"
                                            title="登出"
                                        >
                                            <LogOut size={14} />
                                            <span>登出</span>
                                        </button>
                                    </div>
                                )}
                                {view === 'quiz' && (
                                    <button 
                                        onClick={() => {
                                            if(window.confirm("確定要退出測驗嗎？進度將不會保存。")) setView('welcome');
                                        }}
                                        className="text-sm text-gray-500 hover:text-red-500"
                                    >
                                        退出測驗
                                    </button>
                                )}
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto py-8">
                        {view === 'welcome' && renderWelcomeScreen()}
                        {view === 'quiz' && renderQuizScreen()}
                        {view === 'results' && renderResultsScreen()}
                        {view === 'history' && renderHistoryScreen()}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>